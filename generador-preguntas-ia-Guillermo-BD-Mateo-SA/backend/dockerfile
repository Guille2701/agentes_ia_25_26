# ETAPA 1: Construcción de la imagen del Backend (Node.js)

# Usamos la imagen completa de Node.js (v20) en lugar de slim 
# porque 'better-sqlite3' requiere herramientas de compilación (Python, make, g++)
# que no están presentes en la versión slim por defecto.
FROM node:20

# Etiqueta para mantener el código en orden
LABEL stage=backend-prod

# Crea y establece el directorio de trabajo
WORKDIR /usr/src/app

# Copia los archivos de dependencias
COPY package*.json ./

# Instala las dependencias y reconstruye los módulos nativos si es necesario
# Esto es CRÍTICO para asegurar que better-sqlite3 funcione en Linux/Docker
RUN npm install

# Copia el resto del código fuente
# NOTA: Asegúrate de tener un .dockerignore que excluya 'node_modules' 
# para no copiar los módulos de Windows al contenedor Linux.
COPY . .

# Expone el puerto donde escucha la aplicación (3002 por defecto en tu código)
EXPOSE 3002

# Define el comando para ejecutar la aplicación al iniciar el contenedor.
# Asumo que tienes un script 'start' en tu package.json.
CMD ["npm", "run", "dev"]